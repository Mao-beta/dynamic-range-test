<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Dynamic Range Test</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{
    margin:0;padding:0;height:100%;
    display:flex;flex-direction:column;
    background:#7f7f7f;
    font-family:sans-serif;
    user-select:none;
    -webkit-user-select:none;
  }
  /* ── 測定バー（枠なし）── */
  #bar{
    flex:0 0 10vh;
    max-height:120px;
    margin:auto;
    width:85vw;
    border:none;
    background:linear-gradient(to right,#fff 0%,#000 100%);
  }
  #msg{
    margin:8px auto;
    font-size:1.1rem;
    color:#fff;
    text-shadow:0 0 3px #000;
  }
  #result{
    white-space:pre-wrap;
    text-align:center;
    font-size:1.1rem;
    color:#fff;
  }
  button{
    padding:0.35rem 1rem;
    font-size:1rem;
    margin:4px;
    border-radius:6px;
  }
</style>
</head>
<body>
  <div id="msg"></div>
  <div id="bar"></div>
  <div id="result"></div>

<script>
(function(){ startSession(); })();   // ページ読み込み後に初回測定を開始

/* ───────────────────────────────────── */
/*           測定セッション開始           */
/* ───────────────────────────────────── */
function startSession(){

  /*── メタ情報入力 ───────────────────*/
  const haze      = prompt('ヘイズ量（例: 1〜6, A, Low など）', '1') || 'NA';
  const sessionId = 'S' + Date.now();          // ユニーク ID
  const dateISO   = new Date().toISOString();  // 2025-07-27T23:59:12.345Z

  /*── 定数 & 状態 ───────────────────*/
  const bgLuts  = ['#262626','#808080','#e0e0e0'];  // 暗・中・明
  const bgNames = ['dark','mid','bright'];
  const TOTAL   = 21;                              // 白 21 + 黒 21
  let phase = 'W';                                 // 'W':白 -> 'B':黒
  let prevBg = -1;                                 // 直前の背景 idx
  const taps  = [];                                // タップログ

  /*── DOM 要素取得 ───────────────────*/
  const bar = document.getElementById('bar');
  const msg = document.getElementById('msg');
  const res = document.getElementById('result');

  /*── 画面リセット ───────────────────*/
  res.textContent = '';
  document.querySelectorAll('button').forEach(b => b.remove());
  msg.textContent = '白側 1 / 21 をタップしてください';
  changeBg();                                      // 初期背景

  /*── タップイベント ───────────────────*/
  bar.onclick = e => {
    const ratio = +(
      (e.clientX - bar.getBoundingClientRect().left) / bar.clientWidth
    ).toFixed(6);

    taps.push({
      sessionId, date: dateISO, haze,
      tapSeq: taps.length + 1,
      side:  phase === 'W' ? 'white' : 'black',
      background: bgNames[prevBg],
      ratio
    });

    const nSide = taps.filter(t => t.side === (phase === 'W' ? 'white':'black')).length;

    if (nSide < TOTAL){
      msg.textContent = `${phase === 'W' ? '白側':'黒側'} ${nSide + 1} / ${TOTAL} をタップしてください`;
    } else {
      if (phase === 'W'){
        alert('黒側スタート');         // ← ポップアップで切替を明示
        phase = 'B';
        msg.textContent = '黒側 1 / 21 をタップしてください';
      } else {
        finish();                      // 測定終了
      }
    }
    changeBg();
  };

  /*── 背景色を変える（連続同色を回避） ─────────────*/
  function changeBg(){
    let idx;
    do { idx = Math.floor(Math.random()*3); }
    while (idx === prevBg);
    prevBg = idx;
    document.body.style.background = bgLuts[idx];
  }

  /*──────────────────────────────────── */
  /*              測定終了                */
  /*──────────────────────────────────── */
  function finish(){
    bar.onclick = null;                              // タップ受付停止

    /*── 背景別に DRL 計算 ─────────────*/
    const rowsBG = bgNames.map(name => {
      const whites = taps.filter(t => t.side==='white' && t.background===name).map(t => t.ratio);
      const blacks = taps.filter(t => t.side==='black' && t.background===name).map(t => t.ratio);

      const R   = (1 - Math.min(...blacks)) / Math.max(...whites);
      return {
        sessionId, date: dateISO, haze, background: name,
        nWhite: whites.length, meanWhite: avg(whites).toFixed(4),
        nBlack: blacks.length, meanBlack: avg(blacks).toFixed(4),
        R: R.toFixed(6),
        DRL: (10 * Math.log10(R)).toFixed(2)
      };
    });

    /*── iCS 計算 ─────────────────────*/
    const iCS1 = ((+rowsBG[0].meanWhite + +rowsBG[0].meanBlack)/2) -
                 ((+rowsBG[2].meanWhite + +rowsBG[2].meanBlack)/2);
    const iCS2 = +rowsBG[0].DRL - +rowsBG[2].DRL;
    const rowICS = {
      sessionId, date: dateISO, haze,
      iCS1: iCS1.toFixed(4),
      iCS2: iCS2.toFixed(2)
    };

    /*── 結果表示 ─────────────────────*/
    res.textContent =
      `測定完了\nDRL(dark) = ${rowsBG[0].DRL} dB\n` +
      `DRL(bright) = ${rowsBG[2].DRL} dB\n` +
      `iCS1 = ${rowICS.iCS1}\n` +
      `iCS2 = ${rowICS.iCS2}`;

    /*── ダウンロードボタン（3 つ） ─────────────*/
    createSaveButton('Tap CSV を保存',  taps,               `taps_${dateTag()}_${sessionId}.csv`);
    createSaveButton('DRL CSV を保存',  rowsBG,             `drl_background_${dateTag()}_${sessionId}.csv`);
    createSaveButton('iCS CSV を保存',  [rowICS],           `ics_${dateTag()}_${sessionId}.csv`);

    /*── 次回測定ボタン ─────────────────*/
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '新しい測定を開始';
    nextBtn.onclick = startSession;
    res.after(nextBtn);
  }

  /*── ボタン生成ヘルパ ─────────────*/
  function createSaveButton(label, data, filename){
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.onclick = () => downloadCsv(toCsv(data), filename);
    res.after(btn);
  }

  /*── CSV 生成 & ダウンロード ───────*/
  function toCsv(arr){
    const hdr = Object.keys(arr[0]);
    return hdr.join(',') + '\n' +
           arr.map(o => hdr.map(k => o[k]).join(',')).join('\n');
  }
  function downloadCsv(text, filename){
    const bom = '\uFEFF';  // UTF‑8 BOM for Excel compatibility
    const url = URL.createObjectURL(
      new Blob([bom + text], {type:'text/csv;charset=utf-8;'}));
    Object.assign(document.createElement('a'),
                  {href:url,download:filename}).click();
    URL.revokeObjectURL(url);
  }

  /*── ユーティリティ ─────────────*/
  const avg = a => a.reduce((x,y)=>x+y,0) / a.length;
  const pad = n => ('0'+n).slice(-2);
  function dateTag(){
    const d = new Date();
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  }
}
</script>
</body>
</html>
